<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE document PUBLIC
  "-//Apache Software Foundation//DTD XDOC 1.0//EN"
  "http://maven.apache.org/dtd/xdoc_1_0.dtd">
<!--
    Copyright 2015 Hippo

    Licensed under the Apache License, Version 2.0 (the  "License");
    you may not use this file except in compliance with the License.
    You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

    Unless required by applicable law or agreed to in writing, software
    distributed under the License is distributed on an "AS IS"
    BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
    See the License for the specific language governing permissions and
    limitations under the License.
-->
<document>
  <properties>
    <title>Binding Examples</title>
  </properties>
  <body>

    <section name="Binding Examples">

      <p>
        This library can be used in any environment where JCR and Hippo Repository API are available.
        However, just for simiplicty, the following examples are assumed to run in Hippo Updater Editor (a.k.a Groovy Updater).
      </p>

      <p>
        <strong><em>WARNING</em></strong>:
        If you run the following demo scripts in production or in system having too many content, then
        it might cause a critical system overhead or problems.
        So, run the following demo scripts in a local test environment or change the XPath query to narrow the
        search result to a resonably small amount.
      </p>

      <subsection name="Binding a document from JSON">

        <table border="1">
          <tr>
            <th>Name:</th>
            <td>
              Import a document from JSON
            </td>
          </tr>
          <tr>
            <th>Description:</th>
            <td>
              For demonstration purpose, this example groovy script (a) unmarshal <code>ContentNode</code> from JSON,
              (b) creates a document handle and variant node,
              and (c) binds the <code>ContentNode</code> to the document variant node.
            </td>
          </tr>
          <tr>
            <th>XPath query:</th>
            <td>
              <code>/jcr:root</code>
            </td>
          </tr>
          <tr>
            <th>Parameters:</th>
            <td>
              <div class="brush: javascript">
              <source><![CDATA[
{
  "destination": "/content/documents/administration/labels",
  "data" :
  {
    "name" : "examplemessages",
    "primaryType" : "resourcebundle:resourcebundle",
    "mixinTypes" : [ "mix:referenceable" ],
    "properties" : [ {
      "name" : "resourcebundle:descriptions",
      "type" : "STRING",
      "multiple" : true,
      "values" : [ "Example resource bundle document" ]
    }, {
      "name" : "resourcebundle:id",
      "type" : "STRING",
      "multiple" : false,
      "values" : [ "org.example.messages" ]
    }, {
      "name" : "hippostdpubwf:lastModifiedBy",
      "type" : "STRING",
      "multiple" : false,
      "values" : [ "admin" ]
    }, {
      "name" : "hippotranslation:locale",
      "type" : "STRING",
      "multiple" : false,
      "values" : [ "document-type-locale" ]
    }, {
      "name" : "resourcebundle:messages",
      "type" : "STRING",
      "multiple" : true,
      "values" : [ "Example Header Message", "Example Footer Message" ]
    }, {
      "name" : "hippostd:stateSummary",
      "type" : "STRING",
      "multiple" : false,
      "values" : [ "live" ]
    }, {
      "name" : "resourcebundle:keys",
      "type" : "STRING",
      "multiple" : true,
      "values" : [ "header.text", "footer.text" ]
    }, {
      "name" : "hippostd:state",
      "type" : "STRING",
      "multiple" : false,
      "values" : [ "published" ]
    }, {
      "name" : "hippo:availability",
      "type" : "STRING",
      "multiple" : true,
      "values" : [ "live", "preview" ]
    }, {
      "name" : "hippostdpubwf:publicationDate",
      "type" : "DATE",
      "multiple" : false,
      "values" : [ "2014-08-21T22:10:54.657+02:00" ]
    }, {
      "name" : "hippotranslation:id",
      "type" : "STRING",
      "multiple" : false,
      "values" : [ "e9703ff4-d522-4238-bf3b-6016f959e88c" ]
    }, {
      "name" : "hippostdpubwf:lastModificationDate",
      "type" : "DATE",
      "multiple" : false,
      "values" : [ "2014-08-21T22:10:52.812+02:00" ]
    }, {
      "name" : "hippostdpubwf:createdBy",
      "type" : "STRING",
      "multiple" : false,
      "values" : [ "admin" ]
    }, {
      "name" : "hippostdpubwf:creationDate",
      "type" : "DATE",
      "multiple" : false,
      "values" : [ "2014-08-21T22:10:13.443+02:00" ]
    } ],
    "nodes" : [ ]
  }
}
              ]]></source>
              </div>
            </td>
          </tr>
          <tr>
            <td colspan="2">
              <div class="brush: java">
              <source><![CDATA[
package org.hippoecm.frontend.plugins.cms.admin.updater

import org.onehippo.repository.update.BaseNodeUpdateVisitor
import java.util.*
import javax.jcr.query.*
import org.apache.commons.lang.*
import org.hippoecm.repository.api.*
import org.hippoecm.repository.standardworkflow.*
import org.onehippo.repository.documentworkflow.*
import org.onehippo.forge.content.pojo.binder.*
import org.onehippo.forge.content.pojo.binder.jcr.*
import org.onehippo.forge.content.pojo.common.jcr.*
import org.onehippo.forge.content.pojo.common.util.*
import org.onehippo.forge.content.pojo.model.*
import com.fasterxml.jackson.databind.*

class UpdaterTemplate extends BaseNodeUpdateVisitor {

    Session jcrSession
    ContentNodeBinder contentNodeBinder
    DefaultContentNodeJcrBindingItemFilter bindingItemFilter
    ObjectMapper objectMapper

    void initialize(Session jcrSession) {
        this.jcrSession = jcrSession

        contentNodeBinder = new DefaultJcrContentNodeBinder();
        bindingItemFilter = new DefaultContentNodeJcrBindingItemFilter()
        bindingItemFilter.addPropertyPathExclude("jcr:*")
        bindingItemFilter.addPropertyPathExclude("hippo:*")
        bindingItemFilter.addPropertyPathExclude("hippostd:*")
        bindingItemFilter.addPropertyPathExclude("hippostdpubwf:*")

        objectMapper = new ObjectMapper();
    }

    boolean doUpdate(Node node) {
        log.debug "Visiting node ${node.path}"

        // unmarshal JSON to a ContentNode first
        def destination = parametersMap["destination"]
        def dataJson = parametersMap["data"].toString()
        def contentNode = objectMapper.readValue(dataJson, ContentNode.class)

        // let's create a document under the specific folderNode by an auto-generated name like the following
        def newDocumentName = "examplemessages-" + System.currentTimeMillis()
        def destinationFolderNode = jcrSession.getNode(destination)

        WorkflowManager workflowManager = ((HippoWorkspace) jcrSession.getWorkspace()).getWorkflowManager()
        FolderWorkflow folderWorkflow = (FolderWorkflow) workflowManager.getWorkflow("embedded", destinationFolderNode)
        String documentVariantPath = folderWorkflow.add("new-document", "resourcebundle:resourcebundle", newDocumentName)
        Node documentVariantNode = jcrSession.getNode(documentVariantPath)
        Node documentHandleNode = documentVariantNode.getParent()
        EditableWorkflow documentWorkflow = (EditableWorkflow) workflowManager.getWorkflow("default", documentHandleNode)
        Document document = documentWorkflow.obtainEditableInstance()
        documentVariantNode = document.getNode(jcrSession)
        contentNodeBinder.bind(documentVariantNode, contentNode, bindingItemFilter)
        document = documentWorkflow.commitEditableInstance()
        documentVariantNode = document.getNode(jcrSession)
        contentNodeBinder.bind(documentVariantNode, contentNode, bindingItemFilter)
        log.debug "Committed document at " + document.getNode(jcrSession).getPath()

        return false
    }

    boolean undoUpdate(Node node) {
        throw new UnsupportedOperationException('Updater does not implement undoUpdate method')
    }

}
              ]]></source>
              </div>
            </td>
          </tr>
        </table>

      </subsection>

      <subsection name="Binding Binary Content from JSON">

        <table border="1">
          <tr>
            <th>Name:</th>
            <td>
              Import an Image Set from JSON
            </td>
          </tr>
          <tr>
            <th>Description:</th>
            <td>
              For demonstration purpose, this example groovy script (a) unmarshal <code>ContentNode</code> from JSON,
              (b) creates an Image Set node, and (c) binds the <code>ContentNode</code> to the Image Set node.
            </td>
          </tr>
          <tr>
            <th>XPath query:</th>
            <td>
              <code>/jcr:root</code>
            </td>
          </tr>
          <tr>
            <th>Parameters:</th>
            <td></td>
          </tr>
          <tr>
            <td colspan="2">
              <div class="brush: java">
              <source><![CDATA[
package org.hippoecm.frontend.plugins.cms.admin.updater

import org.onehippo.repository.update.BaseNodeUpdateVisitor
import java.util.*
import javax.jcr.query.*
import org.apache.commons.lang.*
import org.onehippo.forge.content.pojo.binder.*
import org.onehippo.forge.content.pojo.binder.jcr.*
import org.onehippo.forge.content.pojo.common.jcr.*
import org.onehippo.forge.content.pojo.common.util.*
import org.onehippo.forge.content.pojo.model.*
import com.fasterxml.jackson.databind.*

class UpdaterTemplate extends BaseNodeUpdateVisitor {

    Session jcrSession
    ContentNodeMapper contentNodeMapper
    ObjectMapper objectMapper

    void initialize(Session jcrSession) {
        this.jcrSession = jcrSession

        contentNodeMapper = new DefaultJcrContentNodeMapper();
        objectMapper = new ObjectMapper();
    }

    boolean doUpdate(Node node) {
        log.debug "Visiting node ${node.path}"

        return false
    }

    boolean undoUpdate(Node node) {
        throw new UnsupportedOperationException('Updater does not implement undoUpdate method')
    }

}
              ]]></source>
              </div>
            </td>
          </tr>
        </table>

      </subsection>

    </section>

  </body>
</document>
